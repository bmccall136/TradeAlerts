{% extends "layout.html" %}
{% block content %}
<div class="container">
    <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
        <form action="{{ url_for('clear_all_alerts') }}" method="post" style="display:inline;">
            <button type="submit" class="btn-clearall">Clear All</button>
        </form>
    </div>
    <table class="alerts-table">
        <thead>
            <tr>
                <th>Time</th>
    <th>Symbol</th>
    <th>Name</th>
    <th>Price</th>
    <th>VWAP</th>
    <th>VWAP Diff</th>
    <th>Spark</th>
    <th>Triggers</th>
    <th>Qty</th>
    <th>Buy</th>
    <th>Clear</th>

            </tr>
        </thead>
        <tbody>
        {% for alert in alerts %}
            <tr>
                <td>{{ alert['timestamp'] }}</td>
                <td>{{ alert['symbol'] }}</td>
                <td>{{ alert['name'] }}</td>
                <td>${{ '%.2f'|format(alert['price']|float) }}</td>
                <td>${{ '%.2f'|format(alert['vwap']|float) }}</td>
                <td style="color:{% if alert['vwap_diff']|float < 0 %}lime{% else %}red{% endif %};">
                    {{ '%.2f'|format(alert['vwap_diff']|float) }}
                </td>
                
                <td>
                    {% if alert['sparkline'] %}
                        {{ alert['sparkline']|safe }}
                    {% endif %}
                </td>
                <td>{{ alert['triggers'] }}</td>
                <td>
                    <input type="number" min="1" value="1" class="qty-input" style="width:60px;">
                </td>
                <td>
                    <button class="buy-btn"
                        onclick="buyStock('{{ alert['symbol'] }}', this)">
                        Buy
                    </button>
                </td>
                <td>
                    <form action="{{ url_for('clear_alert', id=alert['id']) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn-clear">Clear</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
function buyStock(symbol, btn) {
    let row = btn.closest('tr');
    let qty = row.querySelector('.qty-input').value;
    fetch('/simulation/buy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({symbol: symbol, qty: qty})
    })
    .then(res => res.json())
    .then(data => {
        btn.textContent = "Bought!";
        setTimeout(() => btn.textContent = "Buy", 2000);
    });
}
</script>
{% endblock %}
