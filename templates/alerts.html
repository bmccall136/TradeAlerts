{% extends "layout.html" %}
{% block content %}
<div class="container">
  <!-- Optional: place this above or below the table, as you prefer -->
<div style="display: flex; justify-content: flex-end; margin: 16px 0;">
  <form action="{{ url_for('clear_all_alerts') }}" method="post" style="display:inline;">
    <button class="clear-all-btn" type="submit">✏️ Clear All</button>
  </form>
</div>

  <table class="alerts-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>Symbol</th>
        <th>Name</th>
        <th>Price</th>
        <th>VWAP</th>
        <th>VWAP Diff</th>
        <th>Spark</th>
        <th>Triggers</th>
        <th>Qty</th>
        <th>Buy</th>
        <th>Clear</th>
      </tr>
    </thead>
    <tbody>
      {% for alert in alerts %}
      <tr class="alert-row">
        <td>{{ alert['timestamp'] }}</td>
        <td>{{ alert['symbol'] }}</td>
        <td>{{ alert['name'] }}</td>
        <td>${{ '%.2f'|format(alert['price']|float) }}</td>
        <td>{{ alert['vwap'] }}</td>
        <td>
          {% if alert['vwap_diff'] < 0 %}
            <span style="color: #10ff50;">{{ alert['vwap_diff'] }}</span>
          {% else %}
            <span style="color: #ff5151;">+{{ alert['vwap_diff'] }}</span>
          {% endif %}
        </td>
        <td>
          {% if alert['sparkline'] %}
            <div class="sparkline-img">{{ alert['sparkline']|safe }}</div>
          {% endif %}
        </td>
        <td>{{ alert['triggers'] }}</td>
        <td>
          <input type="number" name="qty" value="1" min="1" class="qty-input">
        </td>
        <td>
          <button class="buy-btn" onclick="buyStock('{{ alert['symbol'] }}', this)">Buy</button>
        </td>
        <td>
          <form action="{{ url_for('clear_alert', id=alert['id']) }}" method="post" style="display:inline;">
            <button class="clear-btn" type="submit">Clear</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function buyStock(symbol, button) {
  const row = button.closest('tr');
  const qtyInput = row.querySelector('.qty-input');
  const qty = qtyInput ? parseInt(qtyInput.value) : 1;

  fetch('/simulation/buy', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ symbol: symbol, qty: qty })
  }).then(response => {
    if (response.ok) {
      alert(`Buy order sent for ${symbol} x${qty}`);
    } else {
      alert('Buy failed.');
    }
  });
}
</script>
{% endblock %}