{% extends "layout.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container">
  <h2 class="text-warning text-center mb-4">Backtest Configuration & Results</h2>

  {% set sma_labels = {10: "Short SMA (10)", 20: "Standard SMA (20)", 50: "Long SMA (50)", 100: "100-Day SMA (100)", 200: "200-Day SMA (200)"} %}
  {% set rsi_len_labels = {7: "Fast RSI (7)", 14: "Std RSI (14)", 21: "Slow RSI (21)", 28: "Very Slow RSI (28)"} %}
  {% set rsi_ob_labels = {70: "Overbought (70)", 75: "Very Overbought (75)", 80: "Extreme Overbought (80)", 85: "Max Overbought (85)"} %}
  {% set rsi_os_labels = {20: "Oversold (20)", 25: "Very Oversold (25)", 30: "Extreme Oversold (30)", 35: "Max Oversold (35)"} %}
  {% set macd_fast_labels = {8: "Fast EMA (8)", 12: "Fast EMA (12)", 16: "Fast EMA (16)"} %}
  {% set macd_slow_labels = {18: "Slow EMA (18)", 26: "Slow EMA (26)", 34: "Slow EMA (34)"} %}
  {% set macd_signal_labels = {6: "Signal SMA (6)", 9: "Signal SMA (9)", 12: "Signal SMA (12)"} %}
  {% set bb_length_labels = {10: "BB Short (10)", 20: "BB Std (20)", 30: "BB Long (30)"} %}
  {% set bb_std_labels = {1.5: "1.5σ", 2.0: "2σ", 2.5: "2.5σ"} %}
  {% set vol_mult_labels = {1.0: "Normal ×1.0", 1.5: "High ×1.5", 2.0: "Very High ×2.0", 2.5: "Extreme ×2.5"} %}
  {% set vwap_labels = {0.0: "No VWAP", 0.5: "≥ $0.5", 1.0: "≥ $1.0", 2.0: "≥ $2.0"} %}

    <form id="backtest-form" method="GET" action="{{ url_for('backtest_view') }}">
    <div class="filter-toggle-group mb-4 d-flex align-items-center w-100">
      {% set toggles = [
        {'name':'sma_on',  'label':'SMA',  'icon':'bi-graph-up-arrow'},
        {'name':'rsi_on',  'label':'RSI',  'icon':'bi-speedometer2'},
        {'name':'macd_on', 'label':'MACD', 'icon':'bi-triangle-fill'},
        {'name':'bb_on',   'label':'BB',   'icon':'bi-bar-chart-fill'},
        {'name':'vol_on',  'label':'Vol',  'icon':'bi-bar-chart-lines'},
        {'name':'vwap_on', 'label':'VWAP', 'icon':'bi-calculator'},
        {'name':'news_on', 'label':'News', 'icon':'bi-newspaper'}
      ] %}
      {% for t in toggles %}
        <div class="form-check form-switch me-3">
          <input class="form-check-input" type="checkbox" id="{{t.name}}" name="{{t.name}}" {% if settings[t.name] %}checked{% endif %}>
          <label class="form-check-label" for="{{t.name}}">
            <i class="bi {{t.icon}}"></i> {{t.label}}
          </label>
        </div>
      {% endfor %}
      <button type="submit" class="btn btn-success ms-auto">
        <i class="bi bi-arrow-repeat"></i> Run Backtest
      </button>
    </div>

    <div class="row g-2 align-items-end mb-4">
      <div class="col-6 col-md-2">
        <label for="sma_length" class="form-label">SMA</label>
        <select id="sma_length" name="sma_length" class="form-select">
          {% for v,l in sma_labels.items() %}
            <option value="{{v}}" {% if settings.sma_length==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="rsi_len" class="form-label">RSI Len</label>
        <select id="rsi_len" name="rsi_len" class="form-select">
          {% for v,l in rsi_len_labels.items() %}
            <option value="{{v}}" {% if settings.rsi_len==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="rsi_overbought" class="form-label">OB</label>
        <select id="rsi_overbought" name="rsi_overbought" class="form-select">
          {% for v,l in rsi_ob_labels.items() %}
            <option value="{{v}}" {% if settings.rsi_overbought==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="rsi_oversold" class="form-label">OS</label>
        <select id="rsi_oversold" name="rsi_oversold" class="form-select">
          {% for v,l in rsi_os_labels.items() %}
            <option value="{{v}}" {% if settings.rsi_oversold==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="macd_fast" class="form-label">MACD Fast</label>
        <select id="macd_fast" name="macd_fast" class="form-select">
          {% for v,l in macd_fast_labels.items() %}
            <option value="{{v}}" {% if settings.macd_fast==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="macd_slow" class="form-label">MACD Slow</label>
        <select id="macd_slow" name="macd_slow" class="form-select">
          {% for v,l in macd_slow_labels.items() %}
            <option value="{{v}}" {% if settings.macd_slow==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="macd_signal" class="form-label">MACD Signal</label>
        <select id="macd_signal" name="macd_signal" class="form-select">
          {% for v,l in macd_signal_labels.items() %}
            <option value="{{v}}" {% if settings.macd_signal==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="bb_length" class="form-label">BB Len</label>
        <select id="bb_length" name="bb_length" class="form-select">
          {% for v,l in bb_length_labels.items() %}
            <option value="{{v}}" {% if settings.bb_length==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="bb_std" class="form-label">BB σ</label>
        <select id="bb_std" name="bb_std" class="form-select">
          {% for v,l in bb_std_labels.items() %}
            <option value="{{v}}" {% if settings.bb_std==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-1">
        <label for="vol_multiplier" class="form-label">Vol ×</label>
        <select id="vol_multiplier" name="vol_multiplier" class="form-select">
          {% for v,l in vol_mult_labels.items() %}
            <option value="{{v}}" {% if settings.vol_multiplier==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label for="vwap_threshold" class="form-label">VWAP</label>
        <select id="vwap_threshold" name="vwap_threshold" class="form-select">
          {% for v,l in vwap_labels.items() %}
            <option value="{{v}}" {% if settings.vwap_threshold==v %}selected{% endif %}>{{l}}</option>
          {% endfor %}
        </select>
		<div class="row g-3 mb-4 justify-content-start">
		  <!-- Starting Cash -->
		  <div class="col-6 col-md-3">
			<label for="starting_cash" class="form-label"><i class="bi bi-currency-dollar"></i> Starting Cash</label>
			<select id="starting_cash" name="starting_cash" class="form-select">
			  {% for value in [1000, 5000, 10000, 25000, 50000] %}
				<option value="{{ value }}" {% if settings.starting_cash == value %}selected{% endif %}>${{ value }}</option>
			  {% endfor %}
			</select>
		  </div>

		  <!-- Max Per Trade -->
		  <div class="col-6 col-md-3">
			<label for="max_per_trade" class="form-label"><i class="bi bi-arrow-up-right-circle"></i> Max Per Trade</label>
			<select id="max_per_trade" name="max_per_trade" class="form-select">
			  {% for value in [100, 250, 500, 1000, 2500, 5000] %}
				<option value="{{ value }}" {% if settings.max_per_trade == value %}selected{% endif %}>${{ value }}</option>
			  {% endfor %}
			</select>
		  </div>

		  <!-- Timeframe -->
		  <div class="col-6 col-md-3>
			<label for="timeframe" class="form-label"><i class="bi bi-calendar-range"></i> Timeframe</label>
			<select id="timeframe" name="timeframe" class="form-select">
			  {% for value, label in [('1mo', '1 Month'), ('3mo', '3 Months'), ('6mo', '6 Months'), ('1y', '1 Year')] %}
				<option value="{{ value }}" {% if settings.timeframe == value %}selected{% endif %}>{{ label }}</option>
			  {% endfor %}
			</select>
		  </div>
		</div>

	  </div>
    </div>
  </form>

<div class="table-responsive">
    <table class="table table-striped table-bordered alerts-table text-white">
      <thead class="table-light">
          <th style="width: 20%">Date</th>
          <th style="width: 15%">Type</th>
          <th style="width: 20%">Price</th>
          <th style="width: 15%">Qty</th>
          <th style="width: 15%">P/L</th>
        </tr>
      </thead>
      <tbody id="resultsBody">
        <!-- Results will populate here -->
      </tbody>
    </table>
  </div>

  <div class="text-end text-light me-3">
    <strong>Net Return:</strong> <span id="netReturn">$0.00</span>
  </div>
</div>

<script>
  var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  var popoverList = popoverTriggerList.map(function (el) { return new bootstrap.Popover(el); });
</script>

{% endblock %}
