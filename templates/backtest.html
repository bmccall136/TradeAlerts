{% extends "layout.html" %}
{% block content %}
{# templates/backtest.html #}
  {# — flash messages — #}
  {% with messages = get_flashed_messages() %}
    {% if messages %}
     <div class="alert alert-info alert-dismissible fade show" role="alert">
       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
       {% for msg in messages %}
         <p>{{ msg }}</p>
       {% endfor %}
     </div>
    {% endif %}
  {% endwith %}

  <!-- rest of your backtest UI... -->
<div class="container">
  <div class="d-flex align-items-center position-relative mb-4">

    <!-- Export CSV at absolute left -->
    <a href="{{ url_for('export_backtest') }}"
       class="btn btn-outline-light position-absolute start-0">
      <i class="bi bi-download"></i> Export CSV
    </a>

    <!-- Centered title -->
    <h2 class="text-warning mb-0 mx-auto">Backtest Dashboard</h2>

    <!-- Absolutely positioned reset button on the right -->
    <form method="POST"
          action="{{ url_for('reset_backtest') }}"
          class="position-absolute end-0">
      <button type="submit" class="btn btn-outline-danger">
        <i class="bi bi-x-circle"></i> Reset Backtest DB
      </button>
    </form>
  </div>
</div>

<form id="backtest-form" method="POST" action="{{ url_for('run_backtest') }}">


  <div class="filter-toggle-group mb-4 d-flex align-items-center w-100 flex-wrap">
    {% set toggles = [
      {'name':'sma_on',  'label':'SMA',  'icon':'bi-graph-up-arrow'},
      {'name':'rsi_on',  'label':'RSI',  'icon':'bi-speedometer2'},
      {'name':'macd_on', 'label':'MACD', 'icon':'bi-triangle-fill'},
      {'name':'bb_on',   'label':'BB',   'icon':'bi-bar-chart-fill'},
      {'name':'vol_on',  'label':'Vol',  'icon':'bi-bar-chart-lines'},
      {'name':'vwap_on', 'label':'VWAP', 'icon':'bi-calculator'},
      {'name':'news_on', 'label':'News', 'icon':'bi-newspaper'}
    ] %}
    {% for t in toggles %}
      <div class="form-check form-switch me-3 mb-2">
        <input class="form-check-input"
               type="checkbox"
               id="{{ t.name }}"
               name="{{ t.name }}"
               {% if settings[t.name] %}checked{% endif %}>
        <label class="form-check-label" for="{{ t.name }}">
          <i class="bi {{ t.icon }}"></i> {{ t.label }}
        </label>
      </div>

    {% endfor %}

    <!-- any other selects / inputs here -->
    <button type="submit" class="btn btn-success ms-auto">
      <i class="bi bi-arrow-repeat"></i> Run Backtest
    </button>
</form>


  {# ─── Indicator Settings Form ─── #}
  {% set sma_labels = {10: "Short SMA (10)", 20: "Standard SMA (20)", 50: "Long SMA (50)", 100: "100-Day SMA (100)", 200: "200-Day SMA (200)"} %}
  {% set rsi_len_labels = {7: "Fast RSI (7)", 14: "Std RSI (14)", 21: "Slow RSI (21)", 28: "Very Slow RSI (28)"} %}
  {% set rsi_ob_labels = {70: "Overbought (70)", 75: "Very Overbought (75)", 80: "Extreme Overbought (80)", 85: "Max Overbought (85)"} %}
  {% set rsi_os_labels = {20: "Oversold (20)", 25: "Very Oversold (25)", 30: "Extreme Oversold (30)", 35: "Max Oversold (35)"} %}
  {% set macd_fast_labels = {8: "Fast EMA (8)", 12: "Fast EMA (12)", 16: "Fast EMA (16)"} %}
  {% set macd_slow_labels = {18: "Slow EMA (18)", 26: "Slow EMA (26)", 34: "Slow EMA (34)"} %}
  {% set macd_signal_labels = {6: "Signal SMA (6)", 9: "Signal SMA (9)", 12: "Signal SMA (12)"} %}
  {% set bb_length_labels = {10: "BB Short (10)", 20: "BB Std (20)", 30: "BB Long (30)"} %}
  {% set bb_std_labels = {1.5: "1.5σ", 2.0: "2σ", 2.5: "2.5σ"} %}
  {% set vol_mult_labels = {1.0: "Normal ×1.0", 1.5: "High ×1.5", 2.0: "Very High ×2.0", 2.5: "Extreme ×2.5"} %}
  {% set vwap_labels = {0.0: "No VWAP", 0.5: "≥ $0.5", 1.0: "≥ $1.0", 2.0: "≥ $2.0"} %}
  <!-- Numeric‐filters row -->
  <div class="row g-2 align-items-end mb-4">
    <!-- SMA -->
    <div class="col-6 col-md-2">
      <label for="sma_length" class="form-label"><i class="bi bi-graph-up-arrow"></i> SMA</label>
      <select id="sma_length" name="sma_length" class="form-select">
        {% for v,l in sma_labels.items() %}
          <option value="{{v}}" {% if settings.sma_length==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- RSI Len -->
    <div class="col-6 col-md-1">
      <label for="rsi_len" class="form-label"><i class="bi bi-speedometer2"></i> RSI Len</label>
      <select id="rsi_len" name="rsi_len" class="form-select">
        {% for v,l in rsi_len_labels.items() %}
          <option value="{{v}}" {% if settings.rsi_len==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- RSI OB -->
    <div class="col-6 col-md-1">
      <label for="rsi_overbought" class="form-label">OB</label>
      <select id="rsi_overbought" name="rsi_overbought" class="form-select">
        {% for v,l in rsi_ob_labels.items() %}
          <option value="{{v}}" {% if settings.rsi_overbought==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- RSI OS -->
    <div class="col-6 col-md-1">
      <label for="rsi_oversold" class="form-label">OS</label>
      <select id="rsi_oversold" name="rsi_oversold" class="form-select">
        {% for v,l in rsi_os_labels.items() %}
          <option value="{{v}}" {% if settings.rsi_oversold==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- MACD Fast -->
    <div class="col-6 col-md-1">
      <label for="macd_fast" class="form-label"><i class="bi bi-triangle-fill"></i> Fast</label>
      <select id="macd_fast" name="macd_fast" class="form-select">
        {% for v,l in macd_fast_labels.items() %}
          <option value="{{v}}" {% if settings.macd_fast==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- MACD Slow -->
    <div class="col-6 col-md-1">
      <label for="macd_slow" class="form-label">Slow</label>
      <select id="macd_slow" name="macd_slow" class="form-select">
        {% for v,l in macd_slow_labels.items() %}
          <option value="{{v}}" {% if settings.macd_slow==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
    <!-- MACD Signal -->
    <div class="col-6 col-md-1">
      <label for="macd_signal" class="form-label">Signal</label>
      <select id="macd_signal" name="macd_signal" class="form-select">
        {% for v,l in macd_signal_labels.items() %}
          <option value="{{v}}" {% if settings.macd_signal==v %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>
      <!-- 9) BB length -->
      <div class="col-6 col-md-1">
        <label for="bb_length" class="form-label">
          <i class="bi bi-bar-chart-fill"></i> BB
          <span tabindex="0" class="ms-1 text-muted" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
                title="Bollinger Band Length" data-bs-content="Window length for moving average in Bollinger Bands. Determines centerline period."
          ><i class="bi bi-info-circle-fill"></i></span>
        </label>
        <select id="bb_length" name="bb_length" class="form-select">
          {% for value,label in bb_length_labels.items() %}
            <option value="{{ value }}" {% if settings.bb_length==value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- 10) BB std -->
      <div class="col-6 col-md-1">
        <label for="bb_std" class="form-label">
          <span class="visually-hidden">BB Std Dev</span>
          <span tabindex="0" class="ms-1 text-muted" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
                title="Bollinger Band Std Dev" data-bs-content="Number of standard deviations from moving average for upper/lower bands."
          ><i class="bi bi-info-circle-fill"></i></span>
        </label>
        <select id="bb_std" name="bb_std" class="form-select">
          {% for value,label in bb_std_labels.items() %}
            <option value="{{ value }}" {% if settings.bb_std==value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- 11) Volume multiplier -->
      <div class="col-6 col-md-1">
        <label for="vol_multiplier" class="form-label">
          <i class="bi bi-bar-chart-lines"></i> Vol
          <span tabindex="0" class="ms-1 text-muted" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
                title="Volume Multiplier" data-bs-content="Current volume must exceed (multiplier × 20-period average volume) to trigger."
          ><i class="bi bi-info-circle-fill"></i></span>
        </label>
        <select id="vol_multiplier" name="vol_multiplier" class="form-select">
          {% for value,label in vol_mult_labels.items() %}
            <option value="{{ value }}" {% if settings.vol_multiplier==value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- 12) VWAP threshold -->
      <div class="col-6 col-md-1">
        <label for="vwap_threshold" class="form-label">
          <i class="bi bi-calculator"></i> VWAP
          <span tabindex="0" class="ms-1 text-muted" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-placement="top"
                title="VWAP Threshold" data-bs-content="Price must exceed (live price - VWAP) ≥ threshold to trigger."
          ><i class="bi bi-info-circle-fill"></i></span>
        </label>
        <select id="vwap_threshold" name="vwap_threshold" class="form-select">
          {% for value,label in vwap_labels.items() %}
            <option value="{{ value }}" {% if settings.vwap_threshold==value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
<hr class="my-3 border-secondary">
<div class="row mb-4">
  <div class="col-auto">
    <div class="form-check">
      <input
        class="form-check-input indicator-setting"
        type="checkbox"
        id="rsi_slope_on"
        name="rsi_slope_on"
        value="1"
        {% if settings.rsi_slope_on %}checked{% endif %}
      >
      <label class="form-check-label text-warning" for="rsi_slope_on">
        📈 Require RSI Slope > 0
      </label>
    </div>
  </div>
  <div class="col-auto">
    <div class="form-check">
      <input
        class="form-check-input indicator-setting"
        type="checkbox"
        id="macd_hist_on"
        name="macd_hist_on"
        value="0"
        {% if settings.macd_hist_on %}checked{% endif %}
      >
      <label class="form-check-label text-warning" for="macd_hist_on">
        📊 Require MACD Histogram > 0.5
      </label>
    </div>
  </div>
  <div class="col-auto">
    <div class="form-check">
      <input
        class="form-check-input indicator-setting"
        type="checkbox"
        id="bb_breakout_on"
        name="bb_breakout_on"
        value="1"
        {% if settings.bb_breakout_on %}checked{% endif %}
      >
      <label class="form-check-label text-warning" for="bb_breakout_on">
        🚀 Require BB Breakout
      </label>
    </div>
  </div>
</div>
<div class="row g-3 mb-4 align-items-end">
  <!-- Single‐Entry Only -->
  <div class="col-auto">
    <div class="form-check">
      <input class="form-check-input" 
             type="checkbox" 
             id="single_entry_only" 
             name="single_entry_only"
             {% if settings.single_entry_only %}checked{% endif %}>
      <label class="form-check-label" for="single_entry_only">
        🛑 Single‐Entry Only
      </label>
    </div>
  </div>

  <!-- Use Trailing Stop -->
  <div class="col-auto">
    <div class="form-check">
      <input class="form-check-input" 
             type="checkbox" 
             id="use_trailing_stop" 
             name="use_trailing_stop"
             {% if settings.use_trailing_stop %}checked{% endif %}>
      <label class="form-check-label" for="use_trailing_stop">
        🚧 Use Trailing Stop
      </label>
    </div>
  </div>
  <div class="col-auto">
    <label for="trailing_stop_pct" class="form-label">Stop % </label>
    <input type="number" step="0.01" 
           id="trailing_stop_pct" 
           name="trailing_stop_pct" 
           class="form-control" 
           value="{{ settings.trailing_stop_pct }}">
  </div>

  <!-- Sell After Days -->
  <div class="col-auto">
    <label for="sell_after_days" class="form-label">Sell After Days</label>
    <input type="number" 
           id="sell_after_days" 
           name="sell_after_days" 
           class="form-control" 
           value="{{ settings.sell_after_days or '' }}">
  </div>
</div>

    <div class="row g-3 mb-4 justify-content-start">
      <div class="col-md-3">
        <label for="starting_cash" class="form-label"><i class="bi bi-currency-dollar"></i> Starting Cash</label>
        <select id="starting_cash" name="starting_cash" class="form-select">
          {% for value in [1000, 5000, 10000, 25000, 50000] %}
            <option value="{{ value }}" {% if settings.starting_cash == value %}selected{% endif %}>${{ value }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="max_per_trade" class="form-label"><i class="bi bi-arrow-up-right-circle"></i> Max Per Trade</label>
        <select id="max_per_trade" name="max_per_trade" class="form-select">
          {% for value in [100, 250, 500, 1000, 2500, 5000] %}
            <option value="{{ value }}" {% if settings.max_per_trade == value %}selected{% endif %}>${{ value }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label for="timeframe" class="form-label"><i class="bi bi-calendar-range"></i> Timeframe</label>
        <select id="timeframe" name="timeframe" class="form-select">
          {% for value,label in [('1mo','1 Month'),('3mo','3 Months'),('6mo','6 Months'),('1y','1 Year')] %}
            <option value="{{ value }}" {% if settings.timeframe == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </form>

  {% if trades %}
  <div class="table-responsive">
    <table class="table table-striped table-bordered alerts-table text-white">
<thead class="table-light">
    <tr>
      <th>Symbol</th>
      <th>Date</th>
      <th>Type</th>
      <th>Price</th>
      <th>Qty</th>
      <th>P/L</th>
    </tr>
  </thead>
  <tbody>
    {% for t in trades %}
    <tr>
      <td>{{ t.symbol }}</td>
      <td>{{ t.date }}</td>
      <td>{{ t.action }}</td>
      <td>${{ t.price|round(2) }}</td>
      <td>{{ t.qty }}</td>
      <td>
        {% if t.pnl is not none %}
          ${{ t.pnl|round(2) }}
        {% else %}
          &mdash;
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
  </div>
  <div class="text-end text-light me-3">
    <strong>Net Return:</strong> <span id="netReturn">${{ net_return | round(2) }}</span>
  </div>
  {% endif %}
</div>

<script>
  var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  var popoverList = popoverTriggerList.map(function (el) { return new bootstrap.Popover(el); });
</script>
{% endblock %}

