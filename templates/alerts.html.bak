{# File: templates/alerts.html #}
{% extends "layout.html" %}
{% block content %}
<style>
  /* 1) Shrink overall font and padding for alerts table */
  table.alerts-table th,
  table.alerts-table td {
    padding: 2px 4px;
    font-size: 12px;
    white-space: nowrap;          /* Prevent multi‚Äêline wrapping */
    overflow: hidden;             /* Ensure overflow text can be truncated */
    text-overflow: ellipsis;      /* Show ‚Äú‚Ä¶‚Äù for overflowed text */
  }

  /* 2) Force fixed layout so columns use percentage widths */
  table.alerts-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }

  /* 3) Assign approximate percentages to each column (adjust as needed) */
  table.alerts-table th:nth-child(1),  /* Time */
  table.alerts-table td:nth-child(1)   { width: 14%; }

  table.alerts-table th:nth-child(2),  /* Symbol */
  table.alerts-table td:nth-child(2)   { width: 6%; }

  table.alerts-table th:nth-child(3),  /* Name */
  table.alerts-table td:nth-child(3)   { width: 18%; }

  table.alerts-table th:nth-child(4),  /* Price */
  table.alerts-table td:nth-child(4)   { width: 8%; }

  table.alerts-table th:nth-child(5),  /* VWAP */
  table.alerts-table td:nth-child(5)   { width: 8%; }

  table.alerts-table th:nth-child(6),  /* VWAP Diff */
  table.alerts-table td:nth-child(6)   { width: 8%; }

  table.alerts-table th:nth-child(7),  /* News */
  table.alerts-table td:nth-child(7)   { width: 6%; }

  table.alerts-table th:nth-child(8),  /* Spark */
  table.alerts-table td:nth-child(8)   { width: 20%; }

  table.alerts-table th:nth-child(9),  /* Triggers */
  table.alerts-table td:nth-child(9)   { width: 12%; }
</style>

<div class="container">
  <!-- ‚îÄ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ‚îÄ -->
  <form id="indicator-form" method="GET" action="{{ url_for('index') }}">
    <div class="row g-2 align-items-end mb-4">

      <!-- 1) Match ‚ÄúN of 6‚Äù -->
      <div class="col-6 col-md-2">
        <label for="match_count" class="form-label">
          <i class="bi bi-funnel-fill"></i> Match
        </label>
        <select id="match_count" name="match_count" class="form-select">
          {% for i in range(1, 7) %}
            <option value="{{ i }}"
              {% if settings.match_count == i %}selected{% endif %}>
              {{ i }} of 6
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 2) SMA length -->
      <div class="col-6 col-md-2">
        <label for="sma_length" class="form-label">
          <i class="bi bi-graph-up-arrow"></i> SMA
        </label>
        <select id="sma_length" name="sma_length" class="form-select">
          {% for length in [10, 20, 50, 100, 200] %}
            <option value="{{ length }}"
              {% if settings.sma_length == length %}selected{% endif %}>
              {{ length }}
            </option>
          {% endfor %}
        </select>
      </div>

 {# ‚îÄ‚îÄ Friendly labels for RSI thresholds ‚îÄ‚îÄ #}
  {% set rsi_ob_labels = {
      70: "Overbought (70)",
      75: "Very Overbought (75)",
      80: "Extreme Overbought (80)",
      85: "Max Overbought (85)"
  } %}
  {% set rsi_os_labels = {
      20: "Oversold (20)",
      25: "Very Oversold (25)",
      30: "Extreme Oversold (30)",
      35: "Max Oversold (35)"
  } %}

  <form method="GET" action="{{ url_for('index') }}">
    <div class="row g-2 align-items-end mb-4">

      <!-- 3a) RSI length (unchanged) -->
      <div class="col-6 col-md-1">
        <label for="rsi_len" class="form-label">
          <i class="bi bi-speedometer2"></i> RSI
        </label>
        <select id="rsi_len" name="rsi_len" class="form-select">
          {% for length in [7, 14, 21, 28] %}
            <option value="{{ length }}" {% if settings.rsi_len == length %}selected{% endif %}>
              {{ length }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 3b) RSI overbought (friendly labels) -->
      <div class="col-6 col-md-1">
        <label for="rsi_overbought" class="form-label">&nbsp;</label>
        <select id="rsi_overbought" name="rsi_overbought" class="form-select">
          {% for value,label in rsi_ob_labels.items() %}
            <option value="{{ value }}" {% if settings.rsi_overbought == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 3c) RSI oversold (friendly labels) -->
      <div class="col-6 col-md-1">
        <label for="rsi_oversold" class="form-label">&nbsp;</label>
        <select id="rsi_oversold" name="rsi_oversold" class="form-select">
          {% for value,label in rsi_os_labels.items() %}
            <option value="{{ value }}" {% if settings.rsi_oversold == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      {# ‚Ä¶the rest of your filter bar ‚Ä¶ #}

  {# ‚Ä¶alerts table below‚Ä¶ #}

      <!-- 3b) RSI overbought -->
      <div class="col-6 col-md-1">
        <label for="rsi_overbought" class="form-label">&nbsp;</label>
        <select id="rsi_overbought" name="rsi_overbought" class="form-select">
          {% for ob in [70, 75, 80, 85] %}
            <option value="{{ ob }}"
              {% if settings.rsi_overbought == ob %}selected{% endif %}>
              {{ ob }}
            </option>
          {% endfor %}
        </select>
      </div>
      <!-- 3c) RSI oversold -->
      <div class="col-6 col-md-1">
        <label for="rsi_oversold" class="form-label">&nbsp;</label>
        <select id="rsi_oversold" name="rsi_oversold" class="form-select">
          {% for os in [20, 25, 30, 35] %}
            <option value="{{ os }}"
              {% if settings.rsi_oversold == os %}selected{% endif %}>
              {{ os }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 4a) MACD fast -->
      <div class="col-6 col-md-1">
        <label for="macd_fast" class="form-label">
          <i class="bi bi-triangle-fill"></i> MACD
        </label>
        <select id="macd_fast" name="macd_fast" class="form-select">
          {% for fast in [8, 12, 16] %}
            <option value="{{ fast }}"
              {% if settings.macd_fast == fast %}selected{% endif %}>
              {{ fast }}
            </option>
          {% endfor %}
        </select>
      </div>
      <!-- 4b) MACD slow -->
      <div class="col-6 col-md-1">
        <label for="macd_slow" class="form-label">&nbsp;</label>
        <select id="macd_slow" name="macd_slow" class="form-select">
          {% for slow in [18, 26, 34] %}
            <option value="{{ slow }}"
              {% if settings.macd_slow == slow %}selected{% endif %}>
              {{ slow }}
            </option>
          {% endfor %}
        </select>
      </div>
      <!-- 4c) MACD signal -->
      <div class="col-6 col-md-1">
        <label for="macd_signal" class="form-label">&nbsp;</label>
        <select id="macd_signal" name="macd_signal" class="form-select">
          {% for sig in [6, 9, 12] %}
            <option value="{{ sig }}"
              {% if settings.macd_signal == sig %}selected{% endif %}>
              {{ sig }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 5a) Bollinger Bands length -->
      <div class="col-6 col-md-1">
        <label for="bb_length" class="form-label">
          <i class="bi bi-bar-chart-fill"></i> BB
        </label>
        <select id="bb_length" name="bb_length" class="form-select">
          {% for length in [10, 20, 30] %}
            <option value="{{ length }}"
              {% if settings.bb_length == length %}selected{% endif %}>
              {{ length }}
            </option>
          {% endfor %}
        </select>
      </div>
      <!-- 5b) Bollinger Bands stddev -->
      <div class="col-6 col-md-1">
        <label for="bb_std" class="form-label">&nbsp;</label>
        <select id="bb_std" name="bb_std" class="form-select">
          {% for œÉ in [1.5, 2.0, 2.5] %}
            <option value="{{ œÉ }}"
              {% if settings.bb_std == œÉ %}selected{% endif %}>
              {{ œÉ }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 6) Volume multiplier dropdown -->
      <div class="col-6 col-md-1">
        <label for="vol_multiplier" class="form-label">
          <i class="bi bi-bar-chart-lines"></i> Vol
        </label>
        <select id="vol_multiplier" name="vol_multiplier" class="form-select">
          {% for vm in [1.0, 1.5, 2.0, 2.5] %}
            <option value="{{ vm }}"
              {% if settings.vol_multiplier == vm %}selected{% endif %}>
              √ó{{ vm }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 7) VWAP threshold dropdown -->
      <div class="col-6 col-md-1">
        <label for="vwap_threshold" class="form-label">
          <i class="bi bi-calculator"></i> VWAP
        </label>
        <select id="vwap_threshold" name="vwap_threshold" class="form-select">
          {% for vt in [0.0, 0.5, 1.0, 2.0] %}
            <option value="{{ vt }}"
              {% if settings.vwap_threshold == vt %}selected{% endif %}>
              ‚â•${{ '%.1f'|format(vt) }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 8) News toggle -->
      <div class="col-6 col-md-1">
        <label class="form-label">
          <i class="bi bi-newspaper"></i> News
        </label>
        <div class="form-check form-switch">
          <input
            class="form-check-input"
            type="checkbox"
            id="news_on"
            name="news_on"
            value="1"
            {% if settings.news_on %}checked{% endif %} />
          <label class="form-check-label" for="news_on">On/Off</label>
        </div>
      </div>

      <!-- 9) Apply button -->
      <div class="col-6 col-md-1 text-end">
        <button
          type="submit"
          class="btn btn-success w-100"
        >
          <i class="bi bi-arrow-repeat"></i> Apply
        </button>
      </div>

    </div>
  </form>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}


  <!-- ‚îÄ‚îÄ‚îÄ ‚ÄúClear All‚Äù & Alerts Table (unchanged) ‚îÄ‚îÄ‚îÄ #-->
  <div class="d-flex justify-content-end mb-2">
    <form action="{{ url_for('clear_all_alerts') }}" method="post" class="d-inline">
      <button class="btn btn-sm btn-outline-warning" type="submit">
        ‚úèÔ∏è Clear All
      </button>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered alerts-table text-white">
      <thead class="table-light">
        <tr>
          <th style="width:10%;">Time</th>
          <th style="width:5%;">Symbol</th>
          <th style="width:8%;">Name</th>
          <th style="width:5%;">Price</th>
          <th style="width:7%;">VWAP</th>
          <th style="width:8%;">VWAP Diff</th>
          <th style="width:10%;">News</th>
          <th style="width:10%;">Spark</th>
          <th style="width:15%;">Triggers</th>
          <th style="width:5%;">Qty</th>
          <th style="width:3%;">Buy</th>
          <th style="width:3%;">Clear</th>
        </tr>
      </thead>
      <tbody>
        {% for alert in alerts %}
        <tr class="alert-row">
          <td>{{ alert['timestamp'] }}</td>
          <td>{{ alert['symbol'] }}</td>
          <td>{{ alert['name'] }}</td>
          <td>${{ '%.2f'|format(alert['price']|float) }}</td>
          <td>${{ '%.2f'|format(alert['vwap']|float) }}</td>
          <td>
            {% if alert['vwap_diff'] < 0 %}
              <span class="text-success">
                ${{ '%.2f'|format(alert['vwap_diff']|float) }}
              </span>
            {% else %}
              <span class="text-danger">
                +${{ '%.2f'|format(alert['vwap_diff']|float) }}
              </span>
            {% endif %}
          </td>
          <td class="text-center">
            {% if alert['has_news'] %}
              <button class="news-btn" onclick="showNews('{{ alert['symbol'] }}')">
                üì∞
              </button>
              <div class="news-container" id="news-{{ alert['symbol'] }}"></div>
            {% else %}
              &mdash;
            {% endif %}
          </td>
          <td>
            {% if alert['sparkline'] %}
              <div class="sparkline-img">{{ alert['sparkline']|safe }}</div>
            {% else %}
              &mdash;
            {% endif %}
          </td>
          <td>{{ alert['triggers'] }}</td>
          <td>
            <input
              type="number"
              name="qty"
              value="1"
              min="1"
              class="form-control form-control-sm qty-input"
            />
          </td>
          <td>
            <button
              class="btn-buy btn btn-sm w-100"
              onclick="buyStock('{{ alert['symbol'] }}', this)"
            >
              Buy
            </button>
          </td>
          <td>
            <form
              action="{{ url_for('clear_alert', id=alert['id']) }}"
              method="post"
              class="d-inline"
            >
              <button class="btn-clear btn btn-sm w-100" type="submit">
                Clear
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="12" class="text-center">No alerts to display.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function buyStock(symbol, button) {
  const row = button.closest('tr');
  const qtyInput = row.querySelector('.qty-input');
  const qty = qtyInput ? parseInt(qtyInput.value) : 1;

  fetch('/simulation/buy', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbol: symbol, qty: qty })
  }).then(response => {
    if (response.ok) {
      alert(`Buy order sent for ${symbol} x${qty}`);
    } else {
      alert('Buy failed.');
    }
  });
}

function showNews(symbol) {
  const container = document.getElementById(`news-${symbol}`);
  container.innerHTML = 'Loading...';
  fetch(`/news/${symbol}`)
    .then(resp => resp.json())
    .then(data => {
      let html = '<ul>';
      data.headlines.forEach(h => {
        html += `<li>${h}</li>`;
      });
      html += `</ul><p><strong>Sentiment:</strong> ${data.sentiment}</p>`;
      container.innerHTML = html;
    })
    .catch(err => {
      container.innerHTML = '<p style="color:red;">Error loading news.</p>';
      console.error(err);
    });
}
</script>

{% endblock %}
