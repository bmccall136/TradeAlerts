{# File: templates/alerts.html #}
{% extends "layout.html" %}
{% block content %}
{# …inside alerts.html, right after `{% block content %}`… #}
<div class="container">
  <div class="d-flex align-items-center position-relative mb-4">
    <!-- Export CSV at absolute left -->
    <a href="{{ url_for('export_alerts') }}"
       class="btn btn-outline-light position-absolute start-0">
      <i class="bi bi-download"></i> Export CSV
    </a>

    <!-- Centered title -->
    <h2 class="text-warning mb-0 mx-auto">Alerts Dashboard</h2>

    <!-- (Optional) Clear All alerts on the right -->
    <form method="POST"
          action="{{ url_for('clear_all_alerts') }}"
          class="position-absolute end-0">
      <button type="submit" class="btn btn-outline-danger">
        <i class="bi bi-x-circle"></i> Clear All
      </button>
    </form>
  </div>
</div>

{# …then the rest of your existing form / table below… #}

<style>
  /* 1) Shrink overall font and padding for alerts table */
  table.alerts-table th,
  table.alerts-table td {
    padding: 2px 4px;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* 2) Fixed layout and full width */
  table.alerts-table {
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
  }

  /* 3) Column widths */
  table.alerts-table th:nth-child(1), table.alerts-table td:nth-child(1) { width: 14%; }
  table.alerts-table th:nth-child(2), table.alerts-table td:nth-child(2) { width: 6%; }
  table.alerts-table th:nth-child(3), table.alerts-table td:nth-child(3) { width: 18%; }
  table.alerts-table th:nth-child(4), table.alerts-table td:nth-child(4) { width: 8%; }
  table.alerts-table th:nth-child(5), table.alerts-table td:nth-child(5) { width: 8%; }
  table.alerts-table th:nth-child(6), table.alerts-table td:nth-child(6) { width: 8%; }
  table.alerts-table th:nth-child(7), table.alerts-table td:nth-child(7) { width: 6%; }
  table.alerts-table th:nth-child(8), table.alerts-table td:nth-child(8) { width: %; }
  table.alerts-table th:nth-child(9), table.alerts-table td:nth-child(9) { width: 12%; white-space: normal; }
  table.alerts-table th:nth-child(10), table.alerts-table td:nth-child(10) { width: 5%; }
  table.alerts-table th:nth-child(11), table.alerts-table td:nth-child(11) { width: 3%; }
  table.alerts-table th:nth-child(12), table.alerts-table td:nth-child(12) { width: 3%; }
</style>
<a href="{{ url_for('export_alerts') }}" class="btn btn-outline-light mb-3">
  <i class="bi bi-download"></i> Export CSV
</a>
<div class="container">
  {# ─── Indicator Settings Form ─── #}
  {% set sma_labels = {10: "Short SMA (10)", 20: "Standard SMA (20)", 50: "Long SMA (50)", 100: "100-Day SMA (100)", 200: "200-Day SMA (200)"} %}
  {% set rsi_len_labels = {7: "Fast RSI (7)", 14: "Std RSI (14)", 21: "Slow RSI (21)", 28: "Very Slow RSI (28)"} %}
  {% set rsi_ob_labels = {70: "Overbought (70)", 75: "Very Overbought (75)", 80: "Extreme Overbought (80)", 85: "Max Overbought (85)"} %}
  {% set rsi_os_labels = {20: "Oversold (20)", 25: "Very Oversold (25)", 30: "Extreme Oversold (30)", 35: "Max Oversold (35)"} %}
  {% set macd_fast_labels = {8: "Fast EMA (8)", 12: "Fast EMA (12)", 16: "Fast EMA (16)"} %}
  {% set macd_slow_labels = {18: "Slow EMA (18)", 26: "Slow EMA (26)", 34: "Slow EMA (34)"} %}
  {% set macd_signal_labels = {6: "Signal SMA (6)", 9: "Signal SMA (9)", 12: "Signal SMA (12)"} %}
  {% set bb_length_labels = {10: "BB Short (10)", 20: "BB Std (20)", 30: "BB Long (30)"} %}
  {% set bb_std_labels = {1.5: "1.5σ", 2.0: "2σ", 2.5: "2.5σ"} %}
  {% set vol_mult_labels = {1.0: "Normal ×1.0", 1.5: "High ×1.5", 2.0: "Very High ×2.0", 2.5: "Extreme ×2.5"} %}
  {% set vwap_labels = {0.0: "No VWAP", 0.5: "≥ $0.5", 1.0: "≥ $1.0", 2.0: "≥ $2.0"} %}

{# templates/alerts.html – replace your existing simulation section with this #}

<form id="simulation-form"
      method="POST"
      action="{{ url_for('start_scanner') }}">

  {# ─── 1) Indicator Toggles ─── #}
  <div class="d-flex flex-wrap align-items-center mb-4">
    {% set toggles = [
      {'name':'sma_on',  'label':'SMA',  'icon':'bi-graph-up-arrow'},
      {'name':'rsi_on',  'label':'RSI',  'icon':'bi-speedometer2'},
      {'name':'macd_on', 'label':'MACD', 'icon':'bi-triangle-fill'},
      {'name':'bb_on',   'label':'BB',   'icon':'bi-bar-chart-fill'},
      {'name':'vol_on',  'label':'Vol',  'icon':'bi-bar-chart-lines'},
      {'name':'vwap_on', 'label':'VWAP', 'icon':'bi-calculator'},
      {'name':'news_on', 'label':'News', 'icon':'bi-newspaper'}
    ] %}
    {% for t in toggles %}
      <div class="form-check form-switch me-3 mb-2">
        <input class="form-check-input"
               type="checkbox"
               id="{{ t.name }}"
               name="{{ t.name }}"
               {% if settings[t.name] %}checked{% endif %}>
        <label class="form-check-label" for="{{ t.name }}">
          <i class="bi {{ t.icon }}"></i> {{ t.label }}
        </label>
      </div>
    {% endfor %}
  </div>

  {# ─── 2) Numeric Filters ─── #}
  <div class="row g-2 align-items-end mb-4">
    <div class="col-6 col-md-2">
      <label for="sma_length" class="form-label"><i class="bi bi-graph-up-arrow"></i> SMA</label>
      <select id="sma_length" name="sma_length" class="form-select">
        {% for v,l in sma_labels.items() %}
          <option value="{{ v }}" {% if settings.sma_length==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="rsi_len" class="form-label"><i class="bi bi-speedometer2"></i> RSI Len</label>
      <select id="rsi_len" name="rsi_len" class="form-select">
        {% for v,l in rsi_len_labels.items() %}
          <option value="{{ v }}" {% if settings.rsi_len==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="rsi_overbought" class="form-label">OB</label>
      <select id="rsi_overbought" name="rsi_overbought" class="form-select">
        {% for v,l in rsi_ob_labels.items() %}
          <option value="{{ v }}" {% if settings.rsi_overbought==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="rsi_oversold" class="form-label">OS</label>
      <select id="rsi_oversold" name="rsi_oversold" class="form-select">
        {% for v,l in rsi_os_labels.items() %}
          <option value="{{ v }}" {% if settings.rsi_oversold==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="macd_fast" class="form-label"><i class="bi bi-triangle-fill"></i> Fast</label>
      <select id="macd_fast" name="macd_fast" class="form-select">
        {% for v,l in macd_fast_labels.items() %}
          <option value="{{ v }}" {% if settings.macd_fast==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="macd_slow" class="form-label">Slow</label>
      <select id="macd_slow" name="macd_slow" class="form-select">
        {% for v,l in macd_slow_labels.items() %}
          <option value="{{ v }}" {% if settings.macd_slow==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="macd_signal" class="form-label">Signal</label>
      <select id="macd_signal" name="macd_signal" class="form-select">
        {% for v,l in macd_signal_labels.items() %}
          <option value="{{ v }}" {% if settings.macd_signal==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="bb_length" class="form-label">
        <i class="bi bi-bar-chart-fill"></i> BB
        <i class="bi bi-info-circle-fill ms-1 text-muted" 
           data-bs-toggle="popover" title="Bollinger Band Length"
           data-bs-content="Window for moving average.">
        </i>
      </label>
      <select id="bb_length" name="bb_length" class="form-select">
        {% for v,l in bb_length_labels.items() %}
          <option value="{{ v }}" {% if settings.bb_length==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="bb_std" class="form-label">
        <i class="bi bi-info-circle-fill text-muted" 
           data-bs-toggle="popover" title="BB Std Dev"
           data-bs-content="Number of σ from the moving average.">
        </i>
      </label>
      <select id="bb_std" name="bb_std" class="form-select">
        {% for v,l in bb_std_labels.items() %}
          <option value="{{ v }}" {% if settings.bb_std==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="vol_multiplier" class="form-label">
        <i class="bi bi-bar-chart-lines"></i> Vol
      </label>
      <select id="vol_multiplier" name="vol_multiplier" class="form-select">
        {% for v,l in vol_mult_labels.items() %}
          <option value="{{ v }}" {% if settings.vol_multiplier==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-1">
      <label for="vwap_threshold" class="form-label">
        <i class="bi bi-calculator"></i> VWAP
      </label>
      <select id="vwap_threshold" name="vwap_threshold" class="form-select">
        {% for v,l in vwap_labels.items() %}
          <option value="{{ v }}" {% if settings.vwap_threshold==v %}selected{% endif %}>{{ l }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  {# ─── 3) “Extra” Indicator Toggles ─── #}
  <div class="row mb-4">
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox"
               id="rsi_slope_on" name="rsi_slope_on"
               {% if settings.rsi_slope_on %}checked{% endif %}>
        <label class="form-check-label text-warning" for="rsi_slope_on">
          📈 Require RSI Slope &gt; 0
        </label>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox"
               id="macd_hist_on" name="macd_hist_on"
               {% if settings.macd_hist_on %}checked{% endif %}>
        <label class="form-check-label text-warning" for="macd_hist_on">
          📊 Require MACD Histogram &gt; 0.5
        </label>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox"
               id="bb_breakout_on" name="bb_breakout_on"
               {% if settings.bb_breakout_on %}checked{% endif %}>
        <label class="form-check-label text-warning" for="bb_breakout_on">
          🚀 Require BB Breakout
        </label>
      </div>
    </div>
  </div>

  {# ─── 4) Exit & Risk Parameters ─── #}
  <div class="row g-3 mb-4 align-items-end">
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox"
               id="single_entry_only" name="single_entry_only"
               {% if settings.single_entry_only %}checked{% endif %}>
        <label class="form-check-label" for="single_entry_only">
          🛑 Single-Entry Only
        </label>
      </div>
    </div>
    <div class="col-auto">
      <div class="form-check">
        <input class="form-check-input" type="checkbox"
               id="use_trailing_stop" name="use_trailing_stop"
               {% if settings.use_trailing_stop %}checked{% endif %}>
        <label class="form-check-label" for="use_trailing_stop">
          🚧 Use Trailing Stop
        </label>
      </div>
    </div>
    <div class="col-auto">
      <label for="trailing_stop_pct" class="form-label">Stop %</label>
      <input type="number" step="0.01"
             id="trailing_stop_pct"
             name="trailing_stop_pct"
             class="form-control"
             value="{{ settings.trailing_stop_pct }}">
    </div>
    <div class="col-auto">
      <label for="sell_after_days" class="form-label">Sell After Days</label>
      <input type="number"
             id="sell_after_days"
             name="sell_after_days"
             class="form-control"
             value="{{ settings.sell_after_days or '' }}">
    </div>
  </div>

  {# ─── 5) Money Management ─── #}
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="starting_cash" class="form-label">
        <i class="bi bi-currency-dollar"></i> Starting Cash
      </label>
      <select id="starting_cash" name="starting_cash" class="form-select">
        {% for v in [1000,5000,10000,25000,50000] %}
          <option value="{{ v }}" {% if settings.starting_cash==v %}selected{% endif %}>
            ${{ v }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="max_per_trade" class="form-label">
        <i class="bi bi-arrow-up-right-circle"></i> Max Per Trade
      </label>
      <select id="max_per_trade" name="max_per_trade" class="form-select">
        {% for v in [100,250,500,1000,2500,5000] %}
          <option value="{{ v }}" {% if settings.max_per_trade==v %}selected{% endif %}>
            ${{ v }}
          </option>
        {% endfor %}
      </select>
    </div>
  </div>

  {# ─── 6) Start / Stop Buttons ─── #}
  <div class="d-flex justify-content-end">
    <button type="submit" class="btn btn-success btn-sm me-2">
      ▶️ Start
    </button>
    <button type="submit"
            formaction="{{ url_for('stop_scanner') }}"
            class="btn btn-danger btn-sm">
      ⛔ Stop
    </button>
  </div>
</form>

  <!-- ─── Alerts Table ─── -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered alerts-table text-white">
      <thead class="table-light">
        <tr>
          <th>Time</th><th>Symbol</th><th>Name</th><th>Price</th><th>VWAP</th><th>VWAP Diff</th><th>News</th><th>Spark</th><th>Triggers</th><th>Qty</th><th>Buy</th><th>Clear</th>
        </tr>
      </thead>
<tbody>
  {% for alert in alerts %}
  <tr data-id="{{ alert.id }}">
	<td>{{ alert.timestamp or "--" }}</td>
    <td>{{ alert.symbol }}</td>
    <td>{{ alert.name }}</td>
    <td>${{ "%.2f"|format(alert.price) }}</td>
    <td>${{ "%.2f"|format(alert.vwap) }}</td>
    <td>{{ alert.vwap_diff }}</td>
    <td>{{ alert.news or "—" }}</td>
	<td>{{ alert.sparkline|safe }}</td>
    <td>{{ alert.triggers }}</td>
    <td>
		  <input type="number" class="qty-input" min="1" value="1" />
		</td>
		<td>
		  <button
			class="btn btn-success btn-sm buy-btn"
			data-symbol="{{ alert.symbol }}"
		  >Buy</button>
		</td>
		<td>
		  <button
			class="btn btn-danger btn-sm clear-btn"
			data-id="{{ alert.id }}"
		  >Clear</button>
		</td>

  </tr>
      {% endfor %}
    </tbody>
    </table>
  </div>

  <!-- Replace this:
  <script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
  -->
  <script src="{{ url_for('static', filename='js/alerts.js') }}"></script>
  <script>
  window.addEventListener('DOMContentLoaded',()=>{
    document.querySelectorAll('.indicator-setting').forEach(el=>{
      const key = el.name;
      // 1) On load, rehydr ate from localStorage if present
      const saved = localStorage.getItem(key);
      if (saved !== null) {
        if (el.type === 'checkbox') {
          el.checked = saved === '1';
        } else {
          el.value = saved;
        }
      }
      // 2) On each change, write back
      el.addEventListener('change', ()=>{
        if (el.type === 'checkbox') {
          localStorage.setItem(key, el.checked ? '1':'0');
        } else {
          localStorage.setItem(key, el.value);
        }
      });
    });
  });
</script>

{% endblock %}
