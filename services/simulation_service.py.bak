import time
from services.trading_helpers import (
    nuke_simulation_db,
    fetch_live_data,
    buy_stock,
    sell_stock,
    stop_simulation
)
from services.market_service import get_symbols  # your live universe

def run_simulation_loop(settings):
    """Background loopâ€”purely orchestration."""
    global _sim_stop
    _sim_stop = False

    # start fresh
    nuke_simulation_db()

    symbols = get_symbols()  # comes from market_service now
    while not _sim_stop:
        for sym in symbols:
            data = fetch_live_data(sym)
            if evaluate_entry(data, settings):
                qty = calculate_qty(settings, data)
                buy_stock(sym, qty, data["price"])
            if evaluate_exit(data, settings):
                exit_qty = calculate_exit_qty(data)
                sell_stock(sym, exit_qty, data["price"])
        time.sleep(settings.poll_interval)

# flag to signal stop
_sim_stop = False
def stop_simulation():
    """Signal the loop to exit cleanly."""
    global _sim_stop
    _sim_stop = True
